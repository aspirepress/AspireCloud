# AspirePress Architecture Documentation

Note: this document was mostly generated by AI, then edited by me (Chuck). It's definitely a work in progress.

## Overview

AspirePress is a Laravel-based application designed to interact with WordPress.org's plugin and theme repositories. It provides services for querying, downloading, and managing WordPress plugins and themes. This document describes the architecture of the application, including its major components and systems and how they interact.

The architecture is a basic Laravel monolith, in which Controllers are essentially just glue for dependency-injected services that do most of the work. These services are fairly Laravel-dependent and not always abstracted by interfaces, but they do communicate at the boundaries using framework-independent DTOs rather than Laravel Models or FormRequest classes.

## Major Components

### System Architecture

```
Client/Browser
    │
    ▼
Web Server
    │
    ▼
Controllers
    │
    ├─────► Services ─────► Models ─────► Database
    │                        │
    │                        ▼
    │                      DTOs
    │
    ▼
Views/API Responses
```

### Core Systems

The application is organized into a few core systems:

1. <b>Plugin System</b> - Manages WordPress plugins
2. <b>Theme System</b> - Manages WordPress themes
3. <b>Download System</b> - Handles downloading of plugins and themes

## Detailed Component Breakdown

### Services Layer

The Services layer contains the business logic of the application and is organized into several directories:

```
Services
├── Plugins
│   ├── PluginInformationService
│   ├── PluginUpdateService
│   ├── PluginHotTagsService
│   └── QueryPluginsService
├── Themes
│   ├── ThemeInformationService
│   ├── FeatureListService
│   ├── ThemeHotTagsService
│   └── QueryThemesService
└── Downloads
    └── DownloadService
```

#### Plugin Services

- <b>PluginInformationService</b>: Retrieves detailed information about plugins
- <b>PluginUpdateService</b>: Handles plugin update operations
- <b>PluginHotTagsService</b>: Manages popular plugin tags
- <b>QueryPluginsService</b>: Provides search and filtering capabilities for plugins

#### Theme Services

- <b>ThemeInformationService</b>: Retrieves detailed information about themes
- <b>FeatureListService</b>: Manages theme features
- <b>ThemeHotTagsService</b>: Manages popular theme tags
- <b>QueryThemesService</b>: Provides search and filtering capabilities for themes

#### Download Service

- <b>DownloadService</b>: Handles the downloading of plugins and themes

### Data Layer

The data layer consists of Models and DTOs (Data Transfer Objects):

```
Data Layer
├── Models
│   ├── BaseModel
│   ├── User
│   └── WpOrg Models
│       ├── Asset
│       ├── Author
│       ├── Plugin
│       ├── PluginTag
│       ├── Theme
│       ├── ThemeTag
│       └── ClosedPlugin
└── DTOs/Values
    ├── DTO Base
    └── WpOrg DTOs
        ├── Author
        ├── PageInfo
        ├── Plugin DTOs
        └── Theme DTOs
```

#### Models

The application uses Eloquent models to interact with the database:

- <b>BaseModel</b>: Base class for all models
- <b>User</b>: Represents application users
- <b>WpOrg Models</b>: Models related to WordPress.org entities
    - <b>Asset</b>: Represents plugin/theme assets
    - <b>Author</b>: Represents plugin/theme authors
    - <b>Plugin</b>: Represents WordPress plugins
    - <b>PluginTag</b>: Represents plugin tags
    - <b>Theme</b>: Represents WordPress themes
    - <b>ThemeTag</b>: Represents theme tags
    - <b>ClosedPlugin</b>: Represents plugins that have been closed

#### DTOs (Data Transfer Objects)

The application uses DTOs to transfer data between layers:

- <b>DTO</b>: Base class for all DTOs
- <b>WpOrg DTOs</b>: DTOs related to WordPress.org entities
    - <b>Author</b>: Represents plugin/theme authors
    - <b>PageInfo</b>: Contains pagination information
    - <b>Plugin DTOs</b>: DTOs related to plugins
    - <b>Theme DTOs</b>: DTOs related to themes

### Controller Layer

The controller layer handles HTTP requests and routes them to the appropriate services:

```
Controllers
├── API Controllers
│   └── WpOrg API
│       ├── Core API
│       ├── Downloads API
│       ├── Plugins API
│       ├── SecretKey API
│       └── Themes API
└── PassThroughController
```

### UI Layer

The UI layer is built using Inertia.js and Vue:

```
UI Layer
├── JavaScript
│   ├── app.js
│   ├── bootstrap.js
│   ├── Components
│   ├── Layouts
│   └── Pages
├── CSS
└── Views
```

### Authorization

The application uses Laravel Permission for authorization:

```
Authorization
├── Permission
└── Role
    └── User (has many)
        └── Role (has many)
            └── Permission
```

## Data Flow

### Plugin Query Flow

```
Client -> PluginsAPI Controller -> QueryPluginsService -> Plugin Model
                                                              |
                                                              v
Client <- PluginsAPI Controller <- QueryPluginsService <- Plugin DTOs
```

### Theme Query Flow

```
Client -> ThemesAPI Controller -> QueryThemesService -> Theme Model
                                                            |
                                                            v
Client <- ThemesAPI Controller <- QueryThemesService <- Theme DTOs
```

### Download Flow

```
Client -> DownloadsAPI Controller -> DownloadService -> WordPress.org
                                                            |
                                                            v
Client <- DownloadsAPI Controller <- DownloadService <- Plugin/Theme File
```

## Database Schema

The database schema consists of several tables that store information about plugins, themes, authors, and other entities:

```
+----------------+     +----------------+     +----------------+
| plugins        |     | themes         |     | authors        |
+----------------+     +----------------+     +----------------+
| id             |     | id             |     | id             |
| slug           |     | slug           |     | user_nicename  |
| name           |     | name           |     | profile        |
| description    |     | description    |     | avatar         |
| version        |     | version        |     | display_name   |
| author         |     | author_id      |---->| author         |
| ...            |     | ...            |     | author_url     |
| ac_raw_metadata|     | ac_raw_metadata|     +----------------+
+----------------+     +----------------+
       |                      |
       |                      |
       v                      v
+----------------+     +----------------+
| plugin_tags    |     | theme_tags     |
+----------------+     +----------------+
| id             |     | id             |
| slug           |     | slug           |
| name           |     | name           |
+----------------+     +----------------+
       ^                      ^
       |                      |
       |                      |
+----------------+     +----------------+
| plugin_plugin_ |     | theme_theme_   |
| tags           |     | tags           |
+----------------+     +----------------+
| plugin_id      |     | theme_id       |
| plugin_tag_id  |     | theme_tag_id   |
+----------------+     +----------------+

+----------------+     +----------------+
| closed_plugins |     | assets         |
+----------------+     +----------------+
| id             |     | id             |
| slug           |     | asset_type     |
| name           |     | slug           |
| description    |     | version        |
| closed_date    |     | revision       |
| reason         |     | upstream_path  |
| ac_shadow_id   |---->| local_path     |
| ...            |     | repository     |
+----------------+     +----------------+
```

## Current Implementation Details

### Model Layer

The model layer uses Eloquent models to interact with the database. Key characteristics of the models include:

1. <b>Immutability</b>: Models are considered immutable and are replaced every time they are updated. This is implemented through:
    - Read-only attributes that throw exceptions when modified
   - The use of
     `immutable_datetime` cast for date fields
    - Methods that create new instances rather than modifying existing ones

2. <b>Computed Attributes</b>: Many properties are computed attributes that retrieve data from the
`ac_raw_metadata` JSON field. Examples include:
    -
    `banners`,
    `icons`,
    `ratings`,
    `screenshots` in the Plugin model
    - Similar attributes in the Theme model
    - These are implemented as getters that call methods to retrieve and process data from
      `ac_raw_metadata`

3. <b>Rewrite System</b>: The models include a URL rewriting system that transforms WordPress.org URLs to local URLs. This is currently implemented in the model layer but needs to be moved to a transformation layer on response DTOs.

### DTOs

The application uses the
`dshafik/bag` package for DTOs. In this context, "DTO" is a generic term describing any data class, whether it's a request, response, or quasi-domain-object like Author. DTOs are always immutable and aim for a "make invalid states unrepresentable" philosophy. However, they don't use ultra-rigorous validation rules, given how loose wp.org's protocol often is (e.g.,
`false` is returned in the upstream responses where null would have been more appropriate). The validation rules for DTOs need to be tightened up with a more well-defined transformation/normalization layer to account for upstream's infelicities.

### Import Process

The application imports plugins and themes from AspireSync, a separate tool that syncs data from WordPress.org. The import process involves:

1. Reading JSON data from a file, with each line representing a plugin or theme
2. Extracting metadata including the type (plugin/theme) and status (open/closed)
3. Creating new model instances using the
   `fromSyncMetadata()` method
4. If a resource with the same slug already exists, it's deleted and replaced with the new data

This process aligns with the immutability approach, as models are replaced rather than updated.

### Database Access

The application currently uses Eloquent for queries. The models are abstracted by DTOs to provide a clean interface for the services. The query services will need to be broken into interfaces not dependent on a particular DB access layer or model classes.

### Authorization

The application uses the laravel-permission package for authorization. Currently, the usage is minimal but will be the basis for any expanded authorization.

### UI Framework

The application uses Jetstream for the UI, which is based on Inertia.js and Vue. Both Jetstream widgets and controllers should be considered deprecated however, and will eventually be replaced by a better toolkit and custom controllers wrapping (and thus abstracting) Sanctum and/or Fortify. 
